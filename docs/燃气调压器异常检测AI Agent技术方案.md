# 燃气调压器异常检测与预警AI Agent技术方案

## 1. 项目概述

### 1.1 项目定位
构建一个自主运行的AI Agent系统，通过持续监测燃气调压器的多传感器时间序列数据，自主学习正常运行模式，主动识别异常、分析根因、生成预警并提供决策建议。

### 1.2 Agent核心能力
- **感知能力**：实时采集和理解多维传感器数据
- **推理能力**：基于历史数据和领域知识进行异常判断和根因分析
- **决策能力**：自主评估风险等级，制定预警策略
- **学习能力**：从历史案例中持续学习，优化检测模型
- **交互能力**：与运维人员协作，接收反馈并调整策略

## 2. Agent架构设计

### 2.1 整体架构（BDI模型）

采用Belief-Desire-Intention（信念-愿望-意图）架构：

```
┌─────────────────────────────────────────────────────────────┐
│                      Agent核心层                             │
│                                                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │   Belief     │  │   Desire     │  │  Intention   │      │
│  │  (信念库)    │  │  (目标管理)  │  │  (意图执行)  │      │
│  │              │  │              │  │              │      │
│  │ • 设备状态   │  │ • 保障安全   │  │ • 监测计划   │      │
│  │ • 历史模式   │  │ • 预防故障   │  │ • 分析任务   │      │
│  │ • 领域知识   │  │ • 优化运维   │  │ • 预警动作   │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
│           ↓                ↓                  ↓             │
│  ┌────────────────────────────────────────────────┐        │
│  │            推理引擎 (Reasoning Engine)          │        │
│  │  • 规则推理  • 案例推理  • 概率推理  • 因果推理 │        │
│  └────────────────────────────────────────────────┘        │
└─────────────────────────────────────────────────────────────┘
                            ↕
┌─────────────────────────────────────────────────────────────┐
│                    感知与执行层                              │
│                                                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ 感知模块     │  │ 记忆模块     │  │ 执行模块     │      │
│  │              │  │              │  │              │      │
│  │ • 数据采集   │  │ • 短期记忆   │  │ • 预警推送   │      │
│  │ • 特征提取   │  │ • 长期记忆   │  │ • 报告生成   │      │
│  │ • 模式识别   │  │ • 知识检索   │  │ • 策略调整   │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
                            ↕
┌─────────────────────────────────────────────────────────────┐
│                    工具与环境层                              │
│                                                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ 数据源       │  │ 模型服务     │  │ 外部系统     │      │
│  │              │  │              │  │              │      │
│  │ • 传感器     │  │ • 异常检测   │  │ • 通知服务   │      │
│  │ • 时序数据库 │  │ • 预测模型   │  │ • 工单系统   │      │
│  │ • 知识库     │  │ • 分类模型   │  │ • 可视化     │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 Agent工作流程

**感知 → 理解 → 推理 → 决策 → 执行 → 学习**

1. **感知阶段**：采集传感器数据，提取特征
2. **理解阶段**：将数据转化为设备状态信念
3. **推理阶段**：基于信念和知识进行异常判断
4. **决策阶段**：评估风险，制定响应策略
5. **执行阶段**：发送预警，生成建议
6. **学习阶段**：收集反馈，更新知识库

### 2.3 多Agent协作架构

采用分层多Agent系统：

```
┌─────────────────────────────────────────────────────────────┐
│                  协调Agent (Coordinator)                     │
│  • 任务分配  • 冲突解决  • 全局优化  • 资源调度             │
└─────────────────────────────────────────────────────────────┘
                            ↓
        ┌───────────────────┼───────────────────┐
        ↓                   ↓                   ↓
┌──────────────┐  ┌──────────────┐  ┌──────────────┐
│ 监测Agent    │  │ 分析Agent    │  │ 决策Agent    │
│              │  │              │  │              │
│ • 数据采集   │  │ • 异常检测   │  │ • 风险评估   │
│ • 质量检查   │  │ • 根因分析   │  │ • 策略生成   │
│ • 状态跟踪   │  │ • 趋势预测   │  │ • 优先级排序 │
└──────────────┘  └──────────────┘  └──────────────┘
        ↓                   ↓                   ↓
┌──────────────┐  ┌──────────────┐  ┌──────────────┐
│ 学习Agent    │  │ 通知Agent    │  │ 反馈Agent    │
│              │  │              │  │              │
│ • 模型训练   │  │ • 预警推送   │  │ • 效果评估   │
│ • 知识更新   │  │ • 报告生成   │  │ • 策略优化   │
│ • 参数调优   │  │ • 渠道管理   │  │ • 闭环反馈   │
└──────────────┘  └──────────────┘  └──────────────┘
```

## 3. 技术栈选型

### 3.1 Agent框架与工具

**Agent开发框架**
- **LangGraph**：构建状态机式的Agent工作流
  - 优势：支持复杂的状态转换和循环推理
  - 用途：实现Agent的感知-推理-决策循环

### 3.2 大语言模型（LLM）

**主模型选择**
- **不唯一，提供模型选择功能（以及添加自定义模型能力）**

### 3.3 向量数据库与检索

**向量数据库**
- **Milvus**：高性能向量搜索
  - 用途：存储历史案例向量，实现案例检索
  - 优势：支持过滤、混合搜索、高性能

**Embedding模型**
- **bge-large-zh-v1.5**

**RAG（检索增强生成）**
- 存储历史故障案例、维修记录、专家知识
- 在根因分析时检索相似案例
- 提供上下文增强的决策建议

### 3.4 时序数据处理

**时序数据库**
- **TimescaleDB**
  - 优势：成熟稳定、支持复杂查询、易于集成

**时序分析库**
- **Prophet**（Meta）：时间序列预测
- **statsmodels**：统计分析
- **tslearn**：时序模式匹配

### 3.5 机器学习与异常检测

**异常检测算法**
- **统计方法**：Z-Score、IQR、EWMA
- **无监督学习**：Isolation Forest、LOF、DBSCAN
- **深度学习**（暂定）：LSTM Autoencoder、Transformer

按照以下策略实现：

- **从基准开始**：无论如何，先实现一个 Z-Score或IQR 的基线版本。它简单、可解释，能为你提供最直观的数据洞察和性能底线。

- **用无监督方法探索**：在基线之上，使用 Isolation Forest 对多维特征进行分析，看看能否发现更隐蔽的、关联性的异常。

- **评估时序复杂度**（暂时不用实现）：如果你的数据是明显的时序且模式复杂，用 LSTM-AE 在一个核心设备或关键指标上进行概念验证。比较其与EWMA等传统方法在捕捉时序异常上的效果。

**ML框架（暂时不用实现）**
- **TensorFlow.js**：在bun中运行模型，可能不稳定，但暂时不实现，先不考虑
- **ONNX Runtime**：跨平台模型推理
- **scikit-learn**（Python服务）：传统ML算法

### 3.6 后端技术栈

**运行时与框架**
- **bun** + **TypeScript 5+**
- **NestJS**：企业级框架，支持依赖注入和模块化
  - 集成LangChain、数据库、消息队列
  - 实现Agent的各个模块

**消息队列与任务调度**
- **BullMQ**（基于Redis）：任务队列
  - 用途：异步处理异常检测、根因分析任务
  - 支持优先级、重试、延迟执行

**缓存与状态管理**
- **Redis**：缓存、会话、实时状态
- **用途**：Agent短期记忆、实时数据缓存

### 3.7 前端技术栈

**框架与UI**
- **Next.js 14**：React + SSR
- **shadcn/ui + Tailwind CSS**：组件库
- **Apache ECharts**：数据可视化

**实时通信**
- **WebSocket**：实时数据推送
- **Server-Sent Events (SSE)**：单向推送

### 3.8 开发工具

**Monorepo管理**
- **Turbo**：构建系统
- **yarn**：包管理器

**代码质量**
- **ESLint + Prettier**：代码规范
- **Vitest**：单元测试
- **Playwright**：E2E测试

## 4. Agent核心模块设计

### 4.1 监测Agent（Monitoring Agent）

**职责**
- 持续采集传感器数据
- 实时监控设备状态
- 维护设备运行基线

**关键能力**
- 数据质量检查（缺失值、异常值过滤）
- 特征工程（统计特征、时间特征、差分特征）
- 状态跟踪（设备健康度、运行时长）

**技术实现**
- 使用NestJS定时任务（@nestjs/schedule）
- 数据流处理（RxJS）
- 状态存储（Redis + TimescaleDB）

### 4.2 分析Agent（Analysis Agent）

**职责**
- 异常检测与识别
- 根因分析与推理
- 趋势预测与预警

**关键能力**
- **异常检测**
  - 多层次检测策略（统计 + ML + 规则）
  - 实时检测 + 批量分析
  - 置信度评估

- **根因分析**
  - 相关性分析（Pearson、Granger因果）
  - 案例检索（RAG）
  - 知识图谱推理
  - LLM增强分析

- **趋势预测**
  - 时间序列预测（Prophet）
  - 故障概率估算
  - 剩余寿命预测（RUL）

**技术实现**
- LangGraph状态机工作流
- LangChain工具链（Tool Calling）
- 向量检索（Milvus + bge-large-zh-v1.5）
- LLM推理（支持多模型切换）
- 知识图谱（可选）

### 4.3 决策Agent（Decision Agent）

**职责**
- 风险评估与分级
- 预警策略制定
- 运维建议生成

**关键能力**
- **风险评估**
  - 多维度评分（严重性、紧急性、影响范围）
  - 动态阈值调整
  - 历史案例对比

- **策略生成**
  - 预警等级判定（L1-L4）
  - 通知渠道选择
  - 响应时间要求

- **建议生成**
  - 基于知识库的标准操作程序（SOP）
  - LLM生成个性化建议
  - 备件准备清单

**技术实现**
- 规则引擎（json-rules-engine）
- 决策树/决策表
- LLM Prompt Engineering（支持多模型）
- LangGraph状态管理

### 4.4 学习Agent（Learning Agent）

**职责**
- 从历史数据中学习
- 模型持续优化
- 知识库更新

**关键能力**
- **在线学习**
  - 增量模型更新
  - 阈值自适应调整
  - 新模式识别

- **反馈学习**
  - 收集运维人员反馈
  - 误报/漏报分析
  - 策略效果评估

- **知识提取**
  - 从案例中提取规则
  - 更新故障知识库
  - 优化检索索引

**技术实现**
- 强化学习（可选）
- 主动学习（Active Learning）
- 知识蒸馏（Knowledge Distillation）
- 向量数据库更新

### 4.5 通知Agent（Notification Agent）

**职责**
- 预警信息推送
- 报告生成与分发
- 交互式对话

**关键能力**
- 多渠道推送（邮件、短信、WebSocket、企业微信）
- 消息模板管理
- 推送策略优化（防止疲劳）
- 对话式交互（Chatbot）

**技术实现**
- 消息队列（BullMQ）
- 模板引擎
- WebSocket服务
- LLM对话（可选）

### 4.6 反馈Agent（Feedback Agent）

**职责**
- 收集运维反馈
- 评估预警效果
- 闭环优化

**关键能力**
- 反馈收集（确认、误报标记、处理结果）
- 效果评估（准确率、响应时间、满意度）
- 策略调整建议

**技术实现**
- 反馈表单/API
- 数据分析
- A/B测试框架

## 5. Agent记忆系统

### 5.1 记忆层次

**短期记忆（Working Memory）**
- 存储：Redis
- 内容：当前会话上下文、实时状态、临时计算结果
- 生命周期：分钟到小时级别

**长期记忆（Long-term Memory）**
- 存储：TimescaleDB + Milvus
- 内容：历史数据、故障案例、知识库、模型参数
- 生命周期：持久化

**情景记忆（Episodic Memory）**
- 存储：向量数据库（Milvus）
- 内容：完整的故障事件记录（时间、原因、处理过程、结果）
- 用途：案例检索、经验学习
- Embedding：bge-large-zh-v1.5

### 5.2 记忆检索策略

**混合检索**
- 向量相似度检索（语义相似，基于bge-large-zh-v1.5）
- 关键词检索（精确匹配）
- 时间范围过滤
- 元数据过滤（设备类型、故障类型）
- Milvus混合搜索能力

**记忆整合**
- 将检索到的多个记忆片段整合
- 去重和排序
- 上下文压缩（避免超出LLM上下文窗口）

## 6. Agent推理引擎

### 6.1 推理模式

**规则推理（Rule-based Reasoning）**
- 专家规则库
- IF-THEN规则
- 优势：可解释性强、响应快
- 用途：已知故障模式的快速判断

**案例推理（Case-based Reasoning）**
- 检索相似历史案例
- 案例适配与重用
- 优势：利用历史经验
- 用途：新型故障的参考分析

**概率推理（Probabilistic Reasoning）**
- 贝叶斯网络
- 不确定性量化
- 优势：处理不确定信息
- 用途：风险评估、置信度计算

**因果推理（Causal Reasoning）**
- 因果图谱
- 反事实推理
- 优势：理解根本原因
- 用途：根因分析、预防措施

**LLM增强推理**
- 自然语言推理
- 常识推理
- 优势：灵活性强、可处理复杂场景
- 用途：复杂故障分析、决策建议生成

### 6.2 推理流程

**Chain-of-Thought（思维链）**
1. 观察：当前数据异常表现
2. 假设：可能的故障原因
3. 验证：检查相关指标和历史数据
4. 推理：因果关系分析
5. 结论：最可能的根因
6. 建议：处理措施

**ReAct模式（推理+行动）**
- Thought：思考下一步
- Action：执行工具调用（查询数据、检索案例）
- Observation：观察结果
- 循环直到得出结论

## 7. Agent工具系统

### 7.1 工具定义

Agent可调用的工具集：

**数据查询工具**
- `query_timeseries_data`：查询时序数据
- `get_device_status`：获取设备当前状态
- `get_baseline_stats`：获取基线统计信息

**分析工具**
- `detect_anomaly`：执行异常检测
- `calculate_correlation`：计算指标相关性
- `predict_trend`：预测未来趋势

**检索工具**
- `search_similar_cases`：检索相似案例
- `query_knowledge_base`：查询知识库
- `get_maintenance_history`：获取维修历史

**外部系统工具**
- `send_notification`：发送通知
- `create_work_order`：创建工单
- `query_weather_data`：查询天气数据（可能影响设备）

### 7.2 工具编排

**LangGraph工具编排**
- 定义工具schema
- LLM自主选择和调用工具
- 工具结果反馈给LLM继续推理
- 状态机管理工具调用流程

**工具链（Tool Chain）**
- 预定义的工具调用序列
- 用于标准化流程
- 提高效率和一致性
- LangGraph节点编排

## 8. Agent协作机制

### 8.1 通信协议

**消息传递**
- 基于事件驱动（Event-driven）
- 发布-订阅模式（Pub/Sub）
- 消息格式：JSON Schema定义

**协作模式**
- **顺序协作**：监测 → 分析 → 决策 → 通知
- **并行协作**：多个分析Agent同时处理不同维度
- **协商协作**：多个Agent投票决定最终策略

### 8.2 冲突解决

**优先级机制**
- 安全相关 > 设备保护 > 运维优化
- 高置信度 > 低置信度

**投票机制**
- 多个Agent对同一问题给出判断
- 加权投票决定最终结果

**人工介入**
- 关键决策需要人工确认
- 提供Agent推理过程供审查

## 9. 部署架构

### 9.1 系统部署

**容器化部署**
- Docker + Docker Compose（开发/小规模）
- Kubernetes（生产/大规模）

**服务组件**
- API服务（NestJS + Bun运行时）
- Agent服务（LangGraph工作流引擎）
- 前端服务（Next.js）
- 数据库（TimescaleDB、Redis、Milvus）
- 消息队列（Redis/BullMQ）
- Embedding服务（bge-large-zh-v1.5）

### 9.2 扩展性设计

**水平扩展**
- 无状态Agent服务
- 负载均衡
- 分布式任务队列

**垂直扩展**
- 模型服务独立部署
- Embedding服务独立部署（bge-large-zh-v1.5）
- GPU加速（如需要）
- Bun运行时性能优化

## 10. 监控与运维

### 10.1 Agent监控

**性能指标**
- Agent响应时间
- 工具调用成功率
- 推理准确率
- 资源使用情况

**质量指标**
- 异常检测准确率、召回率
- 误报率、漏报率
- 根因分析准确率
- 用户满意度

### 10.2 可观测性

**日志**
- 结构化日志（JSON）
- Agent推理过程记录
- 工具调用追踪

**追踪**
- 分布式追踪（OpenTelemetry）
- Agent工作流可视化

**指标**
- Prometheus + Grafana
- 自定义业务指标

## 11. 安全与合规

**数据安全**
- 传感器数据加密传输
- 数据库加密存储
- 访问控制（RBAC）

**AI安全**
- Prompt注入防护
- 输出内容审查
- 敏感信息脱敏

**审计**
- Agent决策记录
- 操作日志
- 可追溯性

## 12. 实施路线

**第1阶段（1个月）：基础设施**
- 搭建开发环境（Bun + NestJS + Next.js）
- 部署数据库（TimescaleDB、Redis、Milvus）
- 配置Embedding服务（bge-large-zh-v1.5）
- 实现数据采集模块

**第2阶段（1.5个月）：核心Agent**
- 实现监测Agent和分析Agent
- 集成LangGraph工作流引擎
- 集成多LLM模型支持
- 集成Milvus向量数据库
- 开发异常检测功能（统计方法 + Isolation Forest）
- 开发根因分析功能（RAG检索）

**第3阶段（1个月）：决策与通知**
- 实现决策Agent和通知Agent
- 开发预警推送功能
- 集成前端监控面板（Next.js + ECharts）
- WebSocket实时通信

**第4阶段（0.5个月）：学习与优化**
- 实现反馈Agent和学习Agent
- 建立闭环优化机制
- 系统测试和调优
- 性能优化（Bun运行时）

**总计：4个月**

## 13. 成本估算

**开发成本**
- 后端开发：2人 × 3个月
- 前端开发：1人 × 2个月
- AI/Agent开发：1人 × 4个月

**API成本（月）**
- LLM API：$200-500（根据调用量和模型选择）
- 本地Embedding（bge-large-zh-v1.5）：无API成本

**基础设施（月）**
- 云服务器：$100-200
- TimescaleDB服务：$50-100
- Redis服务：$20-50
- Milvus向量数据库：$50-100（或自建）
- Embedding服务器（GPU可选）：$50-200

**总计：约$470-1150/月运营成本**

## 14. 技术风险与应对

**LLM依赖风险**
- 应对：支持多模型切换（可配置），保留规则引擎作为后备

**成本控制风险**
- 应对：本地Embedding模型（bge-large-zh-v1.5）降低成本，LLM按需调用

**准确率风险**
- 应对：多层检测策略（统计 + Isolation Forest + 规则），人工审核机制

**数据隐私风险**
- 应对：敏感数据脱敏，支持本地部署，本地Embedding模型

**性能风险**
- 应对：Bun运行时提供更好的性能，Milvus高性能向量检索

## 15. 总结

本方案以Agent为核心，构建了一个自主、智能、可学习的燃气调压器异常检测系统。通过LangGraph工作流引擎实现多Agent协作、LLM增强推理、基于Milvus和bge-large-zh-v1.5的RAG知识检索等技术，实现了从数据感知到决策执行的完整闭环，具备持续学习和优化能力。

**核心技术优势：**
- **LangGraph**：提供灵活的状态机式Agent工作流，支持复杂推理循环
- **多模型支持**：可配置的LLM选择，降低供应商锁定风险
- **本地Embedding**：bge-large-zh-v1.5提供高质量中文向量化，无API成本
- **Milvus向量数据库**：高性能案例检索，支持混合搜索
- **Bun运行时**：更快的启动速度和运行性能
- **渐进式实现**：从统计方法开始，逐步引入机器学习，降低实施风险

**实施策略：**
- 第一阶段：基于统计方法（Z-Score、IQR）建立基线
- 第二阶段：引入Isolation Forest处理多维异常
- 第三阶段：集成LLM和RAG增强根因分析
- 第四阶段：建立反馈闭环，持续优化

**可扩展性：**
- 支持水平扩展（无状态服务）
- 支持垂直扩展（独立的模型服务和Embedding服务）
- 模块化设计，易于添加新的Agent和工具
